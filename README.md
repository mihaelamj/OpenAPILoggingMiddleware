# OpenAPI Logging Middleware

A flexible, configurable logging middleware for OpenAPI client and server implementations with support for both console and file logging.

## Features

- ‚úÖ **Dual Parameter System**: Separate `appName` and `logPrefix` for clean file naming and formatted console output
- ‚úÖ **Client & Server Support**: Works with both `ClientMiddleware` and `ServerMiddleware`
- ‚úÖ **Configurable Body Logging**: Control how much request/response body data to log
- ‚úÖ **Multiple Log Handlers**: Simultaneous console (stream) and JSON file logging
- ‚úÖ **Automatic File Naming**: Generates clean filenames from app name and prefix

## Usage

### Basic Usage

```swift
import OpenAPILoggingMiddleware

// Client logging
let clientMiddleware = LoggingMiddleware(
    appName: "NSSpainAPI",
    logPrefix: "üöö APIClient: "
)

// Server logging
let serverMiddleware = await LoggingMiddleware(
    appName: "NSSpainAPI",
    logPrefix: "üñ•Ô∏è ApiServer: "
)
```

### Advanced Configuration

```swift
let middleware = LoggingMiddleware(
    logger: customLogger,                              // Optional custom logger
    bodyLoggingConfiguration: .upTo(maxBytes: 2_000_000), // Log bodies up to 2MB
    appName: "MyApp",                                  // App identifier for files
    logPrefix: "üîß Service: "                          // Console output prefix
)
```

## File Naming

The middleware automatically generates clean, organized log file names:

| appName | logPrefix | File Names |
|---------|-----------|------------|
| `"NSSpainAPI"` | `"üöö APIClient: "` | `_NSSpainAPI_APIClient.json`, `_NSSpainAPI_APIClient.log` |
| `"NSSpainAPI"` | `"üñ•Ô∏è ApiServer: "` | `_NSSpainAPI_ApiServer.json`, `_NSSpainAPI_ApiServer.log` |
| `"MyApp"` | `"Client: "` | `_MyApp_Client.json`, `_MyApp_Client.log` |
| `nil` | `"üöö APIClient: "` | `_APIClient.json`, `_APIClient.log` |
| `nil` | `""` | `_OpenAPILog.json`, `_OpenAPILog.log` |

### File Naming Rules:

1. **With both appName and logPrefix**: `_<appName>_<cleanPrefix>.<ext>`
2. **With appName only**: `_<appName>.<ext>`
3. **With logPrefix only**: `_<cleanPrefix>.<ext>`
4. **Neither provided**: `_OpenAPILog.<ext>` (default)

Clean names are generated by:
- Trimming whitespace
- Removing spaces from prefix
- Filtering to ASCII letters and numbers (removes emojis)

## Log Output

### Console Output (Stream)
Uses the `logPrefix` as-is for visual distinction:

```
üöö APIClient: `method` = `GET`
üöö APIClient: `path` = `/user/me`
üöö APIClient: `statusCode` = `200`
```

### JSON File Output
Structured JSON logs saved to Documents directory:

```json
[
  {
    "timestamp": "16.10.2025. 14:30:45",
    "method": "GET",
    "path": "/user/me",
    "statusCode": "200",
    "responseBody": "{...}"
  }
]
```

## Architecture

The middleware uses a `MultiplexLogHandler` to direct log output to multiple destinations simultaneously. By default, it's configured with:

- **`StreamLogHandler`**: Prints formatted logs to the console (or any specified stream).
- **`JSONFileLogHandler`**: Saves structured JSON logs to a file in the app's Documents directory.

This architecture makes it easy to monitor logs in real-time during development while also persisting them for later analysis.

## Body Logging Policy

Control how request/response bodies are logged:

```swift
// Never log bodies (for sensitive data)
.never

// Log bodies up to specified size (default: 2MB)
.upTo(maxBytes: 1024 * 1024 * 2)
```

## Log Metadata

Each log entry includes:
- HTTP method
- Request path
- Base URL and full path
- Request/response headers (JSON format)
- Request/response body (based on policy)
- Operation ID
- Status code and reason
- Error information (if failed)
- Unique identifier per request

## File Locations

Log files are saved to the system Documents directory:
- **iOS/macOS**: `~/Documents/`
- **JSON logs**: `_<appName>_<prefix>.json`
- **Stream logs**: Currently output to console

## Example Integration

### ApiClient
```swift
self.loggingMiddleware = LoggingMiddleware(
    appName: "NSSpainAPI",
    logPrefix: "üöö APIClient: "
)

self.client = Client(
    serverURL: serverURL,
    transport: transport,
    middlewares: [loggingMiddleware, authMiddleware]
)
```

### ApiServer
```swift
let loggingMiddleware = await LoggingMiddleware(
    appName: "NSSpainAPI",
    logPrefix: "üñ•Ô∏è ApiServer: "
)

try handler.registerHandlers(
    on: transport,
    serverURL: serverURL,
    middlewares: [loggingMiddleware]
)
```

## Thread Safety

The `LoggingMiddleware` is an `actor`, ensuring thread-safe operation across concurrent requests.

## Dependencies

- `swift-openapi-runtime` - OpenAPI runtime support
- `swift-log` - Logging backend
- `HTTPTypes` - HTTP types
